<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Device to EMM secure channel using Azure Function | Nosari20</title><meta name=description content="Create a secure channel for scripts and apps to perform actions and store data to EMM using Azure Functions"><meta name=author content="Florent NOSARI"><meta name=google-site-verification content="l3oU_IprnsBv0fmr4tY7n9XdxnmZ0oum0x1GeGe5hkI"><meta property="og:url" content="https://nosari20.github.io/posts/device-to-intune-channel/"><meta property="og:title" content="Device to EMM secure channel using Azure Function | Nosari20"><meta property="og:author" content="Florent NOSARI"><meta property="og:description" content="Create a secure channel for scripts and apps to perform actions and store data to EMM using Azure Functions"><meta property="og:image" content="https://nosari20.github.io/posts/device-to-intune-channel/_og.png"><meta property="og:article:published_time" content="2023-03-11 00:00:00 +0000 UTC"><meta property="og:article:modified_time" content="2023-03-11 00:00:00 +0000 UTC"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="nosari20.github.io"><meta property="twitter:url" content="https://nosari20.github.io/posts/device-to-intune-channel/"><meta name=twitter:title content="Device to EMM secure channel using Azure Function | Nosari20"><meta name=twitter:description content="Create a secure channel for scripts and apps to perform actions and store data to EMM using Azure Functions"><meta name=twitter:image content="https://nosari20.github.io/posts/device-to-intune-channel/_og.png"><meta name=theme-color content="#302F2A"><link rel=icon href=/images/favicon.png><link rel=stylesheet href="/css/styles.css?v=2.0"><link rel=stylesheet href="/css/print.css?v=1.0" media=print></head><body><nav><div id=nav-toggle><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 17h18a1 1 0 01.117 1.993L21 19H3a1 1 0 01-.117-1.993L3 17h18H3zm0-6 18-.002a1 1 0 01.117 1.993l-.117.007L3 13a1 1 0 01-.117-1.993L3 11l18-.002L3 11zm0-6h18a1 1 0 01.117 1.993L21 7H3a1 1 0 01-.117-1.993L3 5h18H3z" fill="#fff"/></svg></div><a href=/><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.248 16.002c.966.0 1.75.784 1.75 1.75v2.498A1.75 1.75.0 016.248 22H3.75A1.75 1.75.0 012 20.25v-2.498c0-.966.784-1.75 1.75-1.75h2.498zM9.748 18h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 18h11.505H9.748zm-3.5-8.999c.966.0 1.75.784 1.75 1.75v2.498a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 13.249V10.75C2 9.784 2.784 9 3.75 9h2.498zM9.748 11h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 11h11.505H9.748zm-3.5-9c.966.0 1.75.784 1.75 1.75v2.498a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 6.248V3.75C2 2.784 2.784 2 3.75 2h2.498zm3.5 2h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 4h11.505H9.748z" fill="#fff"/></svg>Home</a>
<a href=/tags/device-management/><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.254 8.003c.967.0 1.75.784 1.75 1.75v9.5a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 19.253v-9.5c0-.966.784-1.75 1.75-1.75h4.504zm-2.002 9.495h-.5a.75.75.0 100 1.5h.5a.75.75.0 000-1.5zM21.25 16.5a.75.75.0 01.102 1.493L21.25 18H11v-1.5h10.25zM18.25 5c.966.0 1.75.784 1.75 1.75v7.5A1.75 1.75.0 0118.25 16H11V9A2 2 0 009.15 7.006L9 7H4v-.25C4 5.784 4.784 5 5.75 5h12.5z" fill="#fff"/></svg>Device Management</a>
<a href=/tags/dev-scripting/><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m8.086 18.611 5.996-14.004a1 1 0 011.878.677l-.04.11-5.996 14.004a1 1 0 01-1.878-.677l.04-.11 5.996-14.004L8.086 18.61zm-5.793-7.318 4-4a1 1 0 011.497 1.32l-.083.094L4.414 12l3.293 3.293a1 1 0 01-1.32 1.498l-.094-.084-4-4a1 1 0 01-.083-1.32l.083-.094 4-4-4 4zm14-4.001a1 1 0 011.32-.083l.093.083 4.001 4.001a1 1 0 01.083 1.32l-.083.095-4.001 3.995a1 1 0 01-1.497-1.32l.084-.095L19.584 12l-3.293-3.294a1 1 0 010-1.414z" fill="#fff"/></svg>Dev. / Scripting</a>
<a href=/tags/misc/><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 4.5v6.238c0 .375-.094.744-.273 1.074L7.54 14h8.922l-1.188-2.188A2.25 2.25.0 0115 10.738V4.5h1A.75.75.0 0016 3H8a.75.75.0 000 1.5h1zm8.275 11H6.725l-1.582 2.915A1.75 1.75.0 006.68 21h10.638a1.75 1.75.0 001.538-2.585L17.275 15.5z" fill="#fff"/></svg>Misc.</a><footer><p class="footer text-center">Copyright (Â©) 2022 Florent NOSARI</p></footer></nav><section><header>Nosari20</header><article><image class=image-header alt="Device to EMM secure channel using Azure Function" src=/posts/device-to-intune-channel/_header.png><h1><a class=title href=/posts/device-to-intune-channel/>Device to EMM secure channel using Azure Function</a></h3><div class=metadata>Published on: <time datetime=2023-03-11>Mar 11, 2023</time>
- Last update: <time datetime=2023-03-11>Mar 11, 2023</time><div class=meta-url>Url: https://nosari20.github.io/posts/device-to-intune-channel/</div><ul class=tags><li><a href=https://nosari20.github.io/tags/device-management>device-management</a></li><li><a href=https://nosari20.github.io/tags/windows>windows</a></li><li><a href=https://nosari20.github.io/tags/intune>intune</a></li><li><a href=https://nosari20.github.io/tags/azure>azure</a></li><li><a href=https://nosari20.github.io/tags/android>android</a></li><li><a href=https://nosari20.github.io/tags/macos>macos</a></li></ul></div><p><h2 id=content>Content</h2><ul><li>Purpose and reflexion</li><li>Technical architecture</li><li>Azure Function code</li><li>Clients examples</li></ul><h2 id=purpose-and-reflexion>Purpose and reflexion</h2><p>Sometimes we need to perform custom actions on devices and return data to Intune or perform Intune actions from device, here are some examples:</p><ul><li>Generate random BIOS password from windows device and return it to Intune using script</li><li>Choose device category for Android Dedicated devices</li><li>Add device to group when third-party EDR is activated</li></ul><p>Unfortunately, for the first and the third example, Intune does not offer any solution to report data to Intune and use it in groups. For the second one, a category can be chosen from Company Portal but it is not available for dedicated devices.</p><p>For this reason, I had to find a way to achieve my goals, so I designed a simple architecture with minimal requirements.</p><h2 id=technical-architecture>Technical architecture</h2><p>My solution uses Azure Functions and certificate authentication, which is described in the following diagram:</p><p><img src=/posts/device-to-intune-channel/device-to-intune-channel.drawio.png alt="Secure channel"></p><p>With this system, Graph API credentials are never exposed and clients are limited by features exposed through the Azure Function and no one can impersonate devices because device are authenticated with certificate.</p><h2 id=client-certificates>Client certificates</h2><p>In my case, I use Intune and ,unfortunately, it does not offer the ability to create a free private certificate authority, but I discovered that Intune pushes a certificate which contains Azure DeviceID into each device and we can use it to authenticate devices against our Azure Function. If you are using another MDM solution or push your own certificate use you can obviously use them.</p><p>Using Intune, only Windows and macOS have a certificate which can be verified easily (issued <code>Microsoft Intune MDM Device CA</code>). On Android and iOS we only have the <code>MS-Organization-Access</code> issued certificate but we cannot retrieve the root CA cert and so we cannot verify client certs.</p><p>In my future examples, I will assume that the client certificate used contains the Intune DeviceID in the subject (i.e., Subject = CN=&lt;INTUNE_DEVICEiD>) and it is issued by <code>Microsoft Intune MDM Device CA</code>. Obviously, you can adapt them easily and will also add some examples which do not have the Intune certificate (e.g., Android).</p><h2 id=azure-function-code>Azure Function code</h2><p>I created my Azure Function using the procedure provided in MS documentation <a href=https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-powershell>Quickstart: Create a PowerShell function in Azure using Visual Studio Code</a></p><p>Certificate-based authentication must be set to <code>required</code> to make the process secure, but the function code must include certificate verification as it is not handled automatically. In the following example I will use the certificate provided by Intune (signed by <code>Microsoft Intune MDM Device CA</code>) which contains the Intune device id.</p><p>The file <code>function.json</code> looks like the following</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;bindings&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;authLevel&#34;</span>: <span style=color:#e6db74>&#34;function&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;httpTrigger&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;direction&#34;</span>: <span style=color:#e6db74>&#34;in&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Request&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;methods&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;get&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;post&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;direction&#34;</span>: <span style=color:#e6db74>&#34;out&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Response&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}  
</span></span></code></pre></div><p>The file <code>run.ps1</code> which is the main code is the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>
</span></span><span style=display:flex><span>Using namespace System.Net
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Input bindings are passed in via param block.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Param</span>($Request, $TriggerMetadata)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to check certificate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Check-Certificate() {
</span></span><span style=display:flex><span>    $ClientCertificateBase64 = $Request.Headers.<span style=color:#e6db74>&#34;X-ARR-ClientCert&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Check if certificate is provided</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>If</span> (<span style=color:#f92672>-not</span> $ClientCertificateBase64) {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::BadRequest
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Certificate not provided in request.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Else</span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># If provided, check trust</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Convert certificate to object</span>
</span></span><span style=display:flex><span>        $ClientCertificate = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Certificate2</span>]([<span style=color:#66d9ef>System.Convert</span>]::FromBase64String($ClientCertificateBase64))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Declare CA and sub-CA</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Microsoft Intune Root Certification Authority</span>
</span></span><span style=display:flex><span>        $ca=<span style=color:#e6db74>&#34;MIIFaTCCA1GgAwIBAgIQWhvaqZFB9KVNpmVRc71GWjANBgkqhkiG9w0BAQsFADA4 MTYwNAYDVQQDEy1NaWNyb3NvZnQgSW50dW5lIFJvb3QgQ2VydGlmaWNhdGlvbiBB dXRob3JpdHkwHhcNMjEwODEyMDAwMDAwWhcNMjYwODEyMDAwMDAwWjA4MTYwNAYD VQQDEy1NaWNyb3NvZnQgSW50dW5lIFJvb3QgQ2VydGlmaWNhdGlvbiBBdXRob3Jp dHkwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQDQL63MwZDlW02yCipf dAUGn5Q8sSIc6zjdTkdCRh2SZGVFVLCgFr/EULGw3q7xaOS/mTA2I+koZM+95JvE xfsIy+S7I7rLQjYNuJZVXl0s1xj4hfewF1jk8nWjdEwYfZkbZ+/6pYTOtHg/U3tV seT63tg6Vc94dkUpOmN4tlyuie2qbMbc1VmAyyITcoIFtRspdE9qW1NnwgzGJz/Q KaL2H7LtGyNGwXhH4jSwZa8ZNcwKjJ7wdaG2SNxOgrZsCHv272vugNiGEy4yYwGU CyGOAksOaHEobW87Y92s/q4/5beBa979ZCeH4VSpRo2LcQFH9ZM9r05VpFimg8Pu pcOl2g1WcuBj1MBBjT/YPaVgbZUp9wvqqefhW6m/JGTYaPJ4YrnMnrzem6kwGP5K 3xwHWL/5ANTjWDx6+b7dZ5f1AKf2DQFaxslMk4CqTElABI8Te1QzTG/QOmSzewtV cwcWGo4F7yJyBbnYcqvN5XJWURFjecuoTvyxPG3R2ljfTKSyJhrTkP0hw3Zxr3cn pY0ZtK80mKE0A9pFG597Qy3q/9TJNRtDjeQrr7DCPwQ8cvfeyT568J+hUyAeN7PV hOV/OXkWXZND9bbkYKNE4ebfiNTGCeJX9iIGjZfbzz86eDqEVpgHcJstnWN6VWbR qkrK/p6m5fqYNZCMAN+g4OyHZQIDAQABo28wbTAdBgNVHQ4EFgQUK0nOsQclTJ3m CpPzkLkw9+ZEn5IwDgYDVR0PAQH/BAQDAgGGMBIGA1UdEwEB/wQIMAYBAf8CAQEw FgYDVR0lAQH/BAwwCgYIKwYBBQUHAwIwEAYJKwYBBAGCNxUBBAMCAQAwDQYJKoZI hvcNAQELBQADggIBAGrkO1h+8wKHJHCMf/jRz5DhvigyDOyohx2LlbhL/i/0uSka /u/m9uhi0UXXYX9Y15tpRUjZDqtQAjpnFePNcxe3/RRp5kuqVHaMyOHShjTTJ6YD hKhlZP37qSBuWv+x2RsUrPzVdpFyljJWyJ1yruBJqgJ2sq3lskb8cO94fhcc2StT uO9aB+0YY2ce5OHtOgj39Enx+PRCpweIodhAKdZuTVAX1M4qeBJD87Gg/7b4VfaS aM6Frzrh9VuylCM258Xx1CYGgzTYJCcvCYOHA74nS3XigalsKonbdVHUEac+4D7i P33JSlV1wlxYPPJqayiBam21YtSHmdJKV3pwkFbvlX2+pNioX86E48YaNz4faq3v Cl4xHqMfVfOOG8QLiOnNlHsBKsffD420CKi2SJaKETPJnOLG61265jiT4Yr1mUeW G+tQTquFeFdTTSGfToyXE58IMLhI19hQtf/2HU9aZK/vJsjWPYKCucPCXwQZA2Kk Z/RT8HsSPPet3GyP3gL0nzfacohJ7RKwClE82exXgiGK/UAFqvEL9pwbLJtX4Hx/ +OhT4zQ9CSppKjSBDIRR8gV6G2HY5gWKXq9K+/Dv+m1APPWsR1kTsqy+tAQPRxlK 7bDsXt5GawcCP+FM0vJwd5O+ZPB3x5VLG5OLv48cCRUxf1alMQSfsJz/r2L4&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Microsoft Intune MDM Device CA</span>
</span></span><span style=display:flex><span>        $subca=<span style=color:#e6db74>&#34;MIIEfTCCAmWgAwIBAgIQI7X6IR1qWadNFd0MPsJsLjANBgkqhkiG9w0BAQsFADA4 MTYwNAYDVQQDEy1NaWNyb3NvZnQgSW50dW5lIFJvb3QgQ2VydGlmaWNhdGlvbiBB dXRob3JpdHkwHhcNMjEwODEyMDAwMDAwWhcNMjQwODEyMDAwMDAwWjApMScwJQYD VQQDEx5NaWNyb3NvZnQgSW50dW5lIE1ETSBEZXZpY2UgQ0EwggEiMA0GCSqGSIb3 DQEBAQUAA4IBDwAwggEKAoIBAQDR82LMD3kKPMoBlLcYWUdsklJfCVnvSos1pCNq UVWBxIgOIXd8ypG7XY1YUE44GjDqPBShdQWJmNDGIfqfLWo0grnajWQMefXEa+CA pKD/GvozAIHfYETgwi+YMx3EyNWupfXY4nf/fz2T4xldHuu9iZw4Ty2+Rz1Vg22Y EYbCXShyOqsFG7rHANPs9XkjXWpcWhnNiRAkq999YuIC0aKkD9UmaTcsd055cmOt 0NkAehfCJiB1t9pqdTceqKRx4VxySSQG/pWwTOL2A9V/eRrx5hZaMDZk3kVcPU/o HluY1xzWCY9PiPuX54WDlFFm4B7zklRifPw0GvP1YX92s2h1AgMBAAGjgZEwgY4w HQYDVR0OBBYEFGdrgkv3vEOqV0qZz17a0+8EUuuVMB8GA1UdIwQYMBaAFCtJzrEH JUyd5gqT85C5MPfmRJ+SMBAGCSsGAQQBgjcVAQQDAgEAMA4GA1UdDwEB/wQEAwIB hjAWBgNVHSUBAf8EDDAKBggrBgEFBQcDAjASBgNVHRMBAf8ECDAGAQH/AgEAMA0G CSqGSIb3DQEBCwUAA4ICAQDOd1wgRJfrtiE4ApbiQKcOSVAK5my9EgWuAEhOzpFG hCyhMpGwm8ZTz6+qhlVmACH9h8AM9mmtw3X/BMHKZNL6C/j8XlE3DQPbP0zJUiLU nAzgjYtGxTy9VxWf4LszVOO6jBCUs3ztri22gkEYnDguVchE+6xP3uQ5jLLjYCMi czT9UiSByKD+IRgTlapF0bDK8FufNX5s2h9aNR8S39kAGQin1cWQmHmu/173QYBG uS+XyuJl/2X9YiQDuPaUNDWrZ3kcwHQLsVF+z8up2PfYUGN+KB1FkzlxyLkpG5X7 oebsY0mc4W69aRdYw6D0GnttbJZvjFhMAjyaZtwJVmCBogM7b7oV6ZtrHEBrUxEc MPQWbiBPCNl6bE8PsKVVoiKmIgje80Wm5bwWw7XCUIFyI/feyzTRZEOf8MQSmpB9 CfvISw0Y5REKGsvgmu06eII1jA78HH6fXOs+L/4+zVxEdjsTryE3iESLkEQ4Do4U p9iDQr+k/5Tcell2GLjXw6EeClkBG64+97gT5PfIXsssKgrsGwkry67tkWriu90Q on84T3uTgK3AqO8wvqaEIbILHsiHDFjsiNntmr0dPMZMXS+pNVyu4FgaREjNlEGl MUgUWBmoM420smDzVzLD48qBJ7hr8suL5vXQL0VSkxJes2G8Cl45d5EgCkJonvkf ZQ==&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Create custom chain object to trust only one authority</span>
</span></span><span style=display:flex><span>        $Chain = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Chain</span>]::Create()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Do no check if certficate is revoked</span>
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.RevocationMode = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509RevocationMode</span>]::NoCheck
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Use custom trust store</span>
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.TrustMode = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509ChainTrustMode</span>]::CustomRootTrust
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Add &#39;Microsoft Intune MDM Device CA&#39; and &#39;Microsoft Intune Root Certification Authority&#39; to custom trust store</span>
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.CustomTrustStore.Add([<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Certificate2</span>]([<span style=color:#66d9ef>System.Convert</span>]::FromBase64String($subca)))  | Out-Null
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.CustomTrustStore.Add([<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Certificate2</span>]([<span style=color:#66d9ef>System.Convert</span>]::FromBase64String($ca)))  | Out-Null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## build chain : return true if valid trust chain</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> (<span style=color:#f92672>-not</span> $Chain.build($ClientCertificate)) {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>            Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>                StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::BadRequest
</span></span><span style=display:flex><span>                Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Certificate not valid (</span>$($Chain.ChainStatus.StatusInformation)<span style=color:#e6db74>).&#39;}&#34;</span>
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>Else</span> {
</span></span><span style=display:flex><span>            $ClientCertificate
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># Function to extract DeviceId from certificate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Read-DeviceId() {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># Convert certificate to object</span>
</span></span><span style=display:flex><span>    $ClientCertificate = Check-Certificate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract Common Name</span>
</span></span><span style=display:flex><span>    $AzDeviceId = ($ClientCertificate.Subject <span style=color:#f92672>-replace</span> <span style=color:#e6db74>&#34;([a-z]*=)&#34;</span> -split <span style=color:#e6db74>&#34;,&#34;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $AzDeviceId   
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to set note using Graph API</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Set-Note($IntuneDeviceID,$Note) {
</span></span><span style=display:flex><span>    $Bearer = Get-GraphAPIToken
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Search for device in Intune</span>
</span></span><span style=display:flex><span>    $Body = @{    
</span></span><span style=display:flex><span>        notes = <span style=color:#e6db74>&#34;</span>$Note<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    } | ConvertTo-Json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $Url = <span style=color:#e6db74>&#34;https://graph.microsoft.com/beta/deviceManagement/managedDevices(&#39;</span>$DeviceId<span style=color:#e6db74>&#39;)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $NoteEditRequest = (Invoke-RestMethod -Method <span style=color:#e6db74>&#39;PATCH&#39;</span> -Headers @{Authorization = <span style=color:#e6db74>&#34;Bearer </span>$($Bearer)<span style=color:#e6db74>&#34;</span>} -Uri $Url -Body $Body  -ContentType <span style=color:#e6db74>&#39;application/json&#39;</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Body:</span><span style=color:#ae81ff>`n</span>$Body<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Internal server error.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>    $NoteEditRequest      
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to authenticate and retrieve Graph API OAuth token</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Get-GraphAPIToken() {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    $ApplicationID = <span style=color:#e6db74>&#34;&lt;APP_ID&gt;&#34;</span>
</span></span><span style=display:flex><span>    $TenantID = <span style=color:#e6db74>&#34;&lt;TENANT_ID&#34;</span>
</span></span><span style=display:flex><span>    $AccessSecret = <span style=color:#e6db74>&#34;&lt;SECRET&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $Body = @{    
</span></span><span style=display:flex><span>        Grant_Type    = <span style=color:#e6db74>&#34;client_credentials&#34;</span>
</span></span><span style=display:flex><span>        Scope         = <span style=color:#e6db74>&#34;https://graph.microsoft.com/.default&#34;</span>
</span></span><span style=display:flex><span>        client_Id     = $ApplicationID
</span></span><span style=display:flex><span>        Client_Secret = $AccessSecret
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>        $ConnectGraph = Invoke-RestMethod -Uri <span style=color:#e6db74>&#34;https://login.microsoftonline.com/</span>$TenantID<span style=color:#e6db74>/oauth2/v2.0/token&#34;</span> `
</span></span><span style=display:flex><span>        -Method POST -Body $Body
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Body:</span><span style=color:#ae81ff>`n</span>$Body<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>If</span>(<span style=color:#f92672>-not</span> $ConnectGraph.access_token){
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Internal server error.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $ConnectGraph.access_token
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Handle incomming requests</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>If</span>($Request.Method  <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;POST&#34;</span> <span style=color:#f92672>-and</span> $Request.Query.Action <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;set&#34;</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Retrieve DeviceId</span>
</span></span><span style=display:flex><span>    $DeviceId = Read-DeviceId
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>################ Perform actions on Intune using Graph API  ###########################</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add Azure AD satus to note</span>
</span></span><span style=display:flex><span>    $response = Set-Note $DeviceId <span style=color:#e6db74>&#34;</span>$($Request.Body.Note)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#######################################################################################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Associate values to output bindings by calling &#39;Push-OutputBinding&#39;.</span>
</span></span><span style=display:flex><span>    Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>        StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::OK
</span></span><span style=display:flex><span>        Body = $response
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    exit
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Unknown method / request</span>
</span></span><span style=display:flex><span>Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>    StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::MethodNotAllowed
</span></span><span style=display:flex><span>    Body = $body
</span></span><span style=display:flex><span>})  
</span></span></code></pre></div><h2 id=clients>Clients</h2><h3 id=windows>Windows</h3><h4 id=set-azuread-status-to-notes>Set AzureAD Status to notes</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span><span style=color:#66d9ef>Requires</span> <span style=color:#66d9ef>-RunAsAdministrator</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Load certficate</span>
</span></span><span style=display:flex><span>$ClientCertificate = Get-ChildItem -Path <span style=color:#e6db74>&#34;Cert:\LocalMachine\My\&#34;</span> | Where-Object {$_.Subject <span style=color:#f92672>-like</span> <span style=color:#e6db74>&#34;*Microsoft Intune MDM Device CA*&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Send request</span>
</span></span><span style=display:flex><span>$Url = <span style=color:#e6db74>&#34;&lt;AZURE-FUNCTION_URL&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$Body = @{
</span></span><span style=display:flex><span>            <span style=color:#75715e># Send Azure AD status to device &#39;notes&#39; field</span>
</span></span><span style=display:flex><span>    Note = <span style=color:#e6db74>&#34;</span>$(dsregcmd /status | select -First <span style=color:#ae81ff>10</span>)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>} | ConvertTo-Json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># Perform request</span>
</span></span><span style=display:flex><span>    $response = (Invoke-RestMethod -Method <span style=color:#e6db74>&#39;POST&#39;</span> -Uri <span style=color:#e6db74>&#34;</span>$Url<span style=color:#e6db74>?Action=set&#34;</span> -Body $Body -ContentType <span style=color:#e6db74>&#39;application/json&#39;</span> -Certificate $ClientCertificate)
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Body:</span><span style=color:#ae81ff>`n</span>$Body<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Body:</span><span style=color:#ae81ff>`n</span>$($_.Exception.Response.Body)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>}  
</span></span></code></pre></div><h3 id=macos>macOS</h3><p>Important: at the moment, I have not found a solution to allow a specific app to use a private key using a script or a profile, so a pop-up will appear at first run to allow <code>curl</code> to use the private key. Alternatively, you can push your own certificate and allow all apps to use it.</p><h4 id=set-mdm-profile-to-notes>Set MDM profile to notes</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Search certficate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> findCertAlias <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>    /usr/bin/security find-certificate -a -p &gt; /tmp/certs.pem
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> read line; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$line<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;--BEGIN&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            cert<span style=color:#f92672>=</span>$line
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            cert<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$cert<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$&#39;\n&#39;</span><span style=color:#e6db74>&#34;</span>$line<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$line<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;--END&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;</span>$cert<span style=color:#e6db74>&#34;</span> &gt; /tmp/checkcert.pem
</span></span><span style=display:flex><span>                subject<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl x509 -subject -noout -in /tmp/checkcert.pem | cut -d<span style=color:#f92672>=</span> -f 3<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>                issuer<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl x509 -issuer -noout -in /tmp/checkcert.pem | cut -d<span style=color:#f92672>=</span> -f 3<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$issuer<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Microsoft Intune MDM Device CA&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                    echo $subject
</span></span><span style=display:flex><span>                    break
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span> &lt; /tmp/certs.pem
</span></span><span style=display:flex><span>    rm -f /tmp/certs.pem
</span></span><span style=display:flex><span>    rm -f /tmp/checkcert.pem
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>certAlias<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>findCertAlias<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Send request</span>
</span></span><span style=display:flex><span>Url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;AZURE-FUNCTION_URL&gt;&#34;</span>
</span></span><span style=display:flex><span>response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>CURL_SSL_BACKEND<span style=color:#f92672>=</span>secure_transport curl -X POST $Url --cert <span style=color:#e6db74>&#34;</span>$certAlias<span style=color:#e6db74>&#34;</span> -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#34;{&#39;Note&#39;:&#39;</span><span style=color:#66d9ef>$(</span>profiles status -type enrollment<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#39;}&#34;</span> -sS --write-out <span style=color:#e6db74>&#39;|%{http_code}\n&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>RC<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>RC<span style=color:#e6db74>}</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IFS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;|&#39;</span>
</span></span><span style=display:flex><span>    read -a response <span style=color:#f92672>&lt;&lt;&lt;</span> <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>response[1]<span style=color:#e6db74>}</span> !<span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Error for </span><span style=color:#e6db74>${</span>Url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;HTTP Code: </span><span style=color:#e6db74>${</span>response[1]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Body: </span><span style=color:#e6db74>${</span>response[0]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Error for </span><span style=color:#e6db74>${</span>Url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Exit Code: </span><span style=color:#e6db74>${</span>RC<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Output: </span>$response<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>  
</span></span></code></pre></div><h3 id=android-snippet>Android (snippet)</h3><p>Note: use your own certificate</p><h4 id=set-bluetooth-name-to-note>Set Bluetooth name to note</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load certificate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> privKey = <span style=color:#a6e22e>KeyChain</span>.getPrivateKey(<span style=color:#66d9ef>this</span>.requireContext(), test.certAlias)
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> pubKey = <span style=color:#a6e22e>KeyChain</span>.getCertificateChain(<span style=color:#66d9ef>this</span>.requireContext(), test.certAlias)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (privKey <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// requestAliasPermission(); Ask user to allow certificate access
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Define the certificate alias to be used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> certAlias = <span style=color:#e6db74>&#34;&lt;YOUR_ALIAS&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create custom KeyManager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> keyManager = <span style=color:#66d9ef>object</span>:X509KeyManager {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getCertificateChain</span>(alias: String?): Array&lt;X509Certificate&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> pubKey<span style=color:#f92672>!!</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getPrivateKey</span>(alias: String?): PrivateKey {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> privKey<span style=color:#f92672>!!</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>chooseClientAlias</span>(keyType: Array&lt;<span style=color:#66d9ef>out</span> String&gt;?, issuers: Array&lt;<span style=color:#66d9ef>out</span> Principal&gt;?, socket: Socket ): String {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> certAlias
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getClientAliases</span>(
</span></span><span style=display:flex><span>        keyType: String?,
</span></span><span style=display:flex><span>        issuers: Array&lt;<span style=color:#66d9ef>out</span> Principal&gt;?
</span></span><span style=display:flex><span>    ): Array&lt;String&gt; {
</span></span><span style=display:flex><span>        TODO(<span style=color:#e6db74>&#34;Not yet implemented&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getServerAliases</span>(
</span></span><span style=display:flex><span>        keyType: String?,
</span></span><span style=display:flex><span>        issuers: Array&lt;<span style=color:#66d9ef>out</span> Principal&gt;?
</span></span><span style=display:flex><span>    ): Array&lt;String&gt; {
</span></span><span style=display:flex><span>        TODO(<span style=color:#e6db74>&#34;Not yet implemented&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>chooseServerAlias</span>(
</span></span><span style=display:flex><span>        keyType: String?,
</span></span><span style=display:flex><span>        issuers: Array&lt;<span style=color:#66d9ef>out</span> Principal&gt;?,
</span></span><span style=display:flex><span>        socket: Socket?
</span></span><span style=display:flex><span>    ): String {
</span></span><span style=display:flex><span>        TODO(<span style=color:#e6db74>&#34;Not yet implemented&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create custom SSL context to use certificate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> sslContext = <span style=color:#a6e22e>SSLContext</span>.getInstance(<span style=color:#e6db74>&#34;TLS&#34;</span>)
</span></span><span style=display:flex><span>sslContext.<span style=color:#66d9ef>init</span>(arrayOf&lt;KeyManager&gt;(km), <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>sslFactory = sslContext.socketFactory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create client with custom context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> okHttpClient = <span style=color:#a6e22e>OkHttpClient</span>.Builder()
</span></span><span style=display:flex><span>        .sslSocketFactory(sslFactory.getSslSocketFactory(), sslFactory.getTrustManager().<span style=color:#66d9ef>get</span>())
</span></span><span style=display:flex><span>        .build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> name = <span style=color:#a6e22e>Settings</span>.<span style=color:#a6e22e>System</span>.getString(requireContext().contentResolver, <span style=color:#e6db74>&#34;bluetooth_name&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> Url = <span style=color:#e6db74>&#34;&lt;AZURE-FUNCTION_URL&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> formBody = <span style=color:#a6e22e>FormBody</span>.Builder()
</span></span><span style=display:flex><span>      .add(<span style=color:#e6db74>&#34;note&#34;</span>, name) <span style=color:#75715e>// Request all categories with their ids with the same principle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      .build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> request = <span style=color:#a6e22e>Request</span>.Builder()
</span></span><span style=display:flex><span>    .url(Url)
</span></span><span style=display:flex><span>    .build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Send request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> call = okHttpClient.newCall(request)
</span></span><span style=display:flex><span>call.enqueue(<span style=color:#66d9ef>object</span>:Callback {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onResponse</span>(call:Call, response:Response){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Log</span>.d(<span style=color:#e6db74>&#34;SET-NOTE&#34;</span>,response.body()<span style=color:#f92672>?.</span>string())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onFailure</span>(call: Call, e:IOException) {
</span></span><span style=display:flex><span>        TODO(<span style=color:#e6db74>&#34;Not yet implemented&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})  
</span></span></code></pre></div><p>Note: macOS scripts will be reuseable (with some changes) for Linux when Intune will include script execution for this OS.</p></p></article><div id=comments><script>var id="7",commentsDiv;if(id){let t="https://github.com/nosari20/nosari20.github.io/issues/".concat(id),n="https://api.github.com/repos/nosari20/nosari20.github.io/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"' target='_blank'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"' target='_blank'>",e.user.login,e.user.login=="nosari20"?" (OP)":"","</a></b>","<em> on ",new Date(e.created_at).toLocaleString("en"),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section><script src=/js/app.js></script></body></html>