<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Leverage Android Enterprise delegation scopes | Nosari20</title><meta name=description content="Use Android Enterprise delegation scopes to add new capabilities to your apps."><meta name=author content="Florent NOSARI"><meta name=google-site-verification content="l3oU_IprnsBv0fmr4tY7n9XdxnmZ0oum0x1GeGe5hkI"><meta property="og:url" content="https://nosari20.github.io//posts/android-dpc-delegation/"><meta property="og:title" content="Leverage Android Enterprise delegation scopes | Nosari20"><meta property="og:author" content="Florent NOSARI"><meta property="og:description" content="Use Android Enterprise delegation scopes to add new capabilities to your apps."><meta property="og:image" content="https://nosari20.github.io//posts/android-dpc-delegation/_og.png"><meta property="og:article:published_time" content="2025-05-29 00:00:00 +0000 UTC"><meta property="og:article:modified_time" content="2025-05-29 00:00:00 +0000 UTC"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="nosari20.github.io"><meta property="twitter:url" content="https://nosari20.github.io//posts/android-dpc-delegation/"><meta name=twitter:title content="Leverage Android Enterprise delegation scopes | Nosari20"><meta name=twitter:description content="Use Android Enterprise delegation scopes to add new capabilities to your apps."><meta name=twitter:image content="https://nosari20.github.io//posts/android-dpc-delegation/_og.png"><meta name=theme-color content="#302F2A"><link rel=icon href=/images/favicon.png><link rel=stylesheet href="/css/styles.css?v=2.1"><link rel=stylesheet href="/css/print.css?v=1.0" media=print></head><body><nav><div id=nav-toggle><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M3 17h18a1 1 0 01.117 1.993L21 19H3a1 1 0 01-.117-1.993L3 17h18H3zm0-6 18-.002a1 1 0 01.117 1.993l-.117.007L3 13a1 1 0 01-.117-1.993L3 11l18-.002L3 11zm0-6h18a1 1 0 01.117 1.993L21 7H3a1 1 0 01-.117-1.993L3 5h18H3z" fill="#fff"/></svg></div><a href=/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M6.248 16.002c.966.0 1.75.784 1.75 1.75v2.498A1.75 1.75.0 016.248 22H3.75A1.75 1.75.0 012 20.25v-2.498c0-.966.784-1.75 1.75-1.75h2.498zM9.748 18h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 18h11.505H9.748zm-3.5-8.999c.966.0 1.75.784 1.75 1.75v2.498a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 13.249V10.75C2 9.784 2.784 9 3.75 9h2.498zM9.748 11h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 11h11.505H9.748zm-3.5-9c.966.0 1.75.784 1.75 1.75v2.498a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 6.248V3.75C2 2.784 2.784 2 3.75 2h2.498zm3.5 2h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 4h11.505H9.748z" fill="#fff"/></svg>
Home
</a><a href=/tags/device-management/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M8.254 8.003c.967.0 1.75.784 1.75 1.75v9.5a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 19.253v-9.5c0-.966.784-1.75 1.75-1.75h4.504zm-2.002 9.495h-.5a.75.75.0 100 1.5h.5a.75.75.0 000-1.5zM21.25 16.5a.75.75.0 01.102 1.493L21.25 18H11v-1.5h10.25zM18.25 5c.966.0 1.75.784 1.75 1.75v7.5A1.75 1.75.0 0118.25 16H11V9A2 2 0 009.15 7.006L9 7H4v-.25C4 5.784 4.784 5 5.75 5h12.5z" fill="#fff"/></svg>
Device Management
</a><a href=/tags/dev-scripting/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="m8.086 18.611 5.996-14.004a1 1 0 011.878.677l-.04.11-5.996 14.004a1 1 0 01-1.878-.677l.04-.11 5.996-14.004L8.086 18.61zm-5.793-7.318 4-4a1 1 0 011.497 1.32l-.083.094L4.414 12l3.293 3.293a1 1 0 01-1.32 1.498l-.094-.084-4-4a1 1 0 01-.083-1.32l.083-.094 4-4-4 4zm14-4.001a1 1 0 011.32-.083l.093.083 4.001 4.001a1 1 0 01.083 1.32l-.083.095-4.001 3.995a1 1 0 01-1.497-1.32l.084-.095L19.584 12l-3.293-3.294a1 1 0 010-1.414z" fill="#fff"/></svg>
Dev. / Scripting
</a><a href=/tags/misc/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M9 4.5v6.238c0 .375-.094.744-.273 1.074L7.54 14h8.922l-1.188-2.188A2.25 2.25.0 0115 10.738V4.5h1A.75.75.0 0016 3H8a.75.75.0 000 1.5h1zm8.275 11H6.725l-1.582 2.915A1.75 1.75.0 006.68 21h10.638a1.75 1.75.0 001.538-2.585L17.275 15.5z" fill="#fff"/></svg>
Misc.</a><footer><p class="footer text-center">Copyright (©) 2024 Florent NOSARI</p></footer></nav><section><header><span>Nosari20</span>
<span style=text-align:right><a href=https://github.com/nosari20/ target=_blank><svg height="26" aria-hidden="true" viewBox="0 0 24 24" width="32" data-view-component="true"><path d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546.0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678.0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048.0.0.963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977.0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09.0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128.0 1.538-.014 2.774-.014 3.162.0.302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75z" fill="#fff"/></svg></a></span></header><article><image class=image-header alt="Leverage Android Enterprise delegation scopes" src=/posts/android-dpc-delegation/_header.png><h1><a class=title href=/posts/android-dpc-delegation/>Leverage Android Enterprise delegation scopes</a></h3><div class=metadata>Published on: <time datetime=2025-05-29>May 29, 2025</time>
- Last update: <time datetime=2025-05-29>May 29, 2025</time><div class=meta-url>Url: https://nosari20.github.io/posts/android-dpc-delegation/</div><ul class=tags><li><a href=https://nosari20.github.io/tags/device-management>device-management</a></li><li><a href=https://nosari20.github.io/tags/android>android</a></li></ul></div><p><h2 id=content>Content</h2><ul><li>Delegation scopes</li><li>Examples</li><li>Sources / usefull resources</li></ul><h2 id=delegation-scopes>Delegation scopes</h2><p>Android Enterprise delegation scopes define specific permissions that a Device Policy Pontroller (DPC) can delegate to other apps. These scopes allow other apps to perform defined management tasks such as certificate installation or app management without having full device admin privileges. Here are the available delegation scopes:</p><ul><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_APP_RESTRICTIONS><code>DELEGATION_APP_RESTRICTIONS</code></a><br>→ allows app to get and set application restrictions (DPC is still able to set app restrictions).</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_BLOCK_UNINSTALL><code>DELEGATION_BLOCK_UNINSTALL</code></a><br>→ allows app prevent uninstallation of specified apps.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_CERT_INSTALL><code>DELEGATION_CERT_INSTALL</code></a><br>→ allows app to list and install CA certificates and authentication certificates.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_CERT_SELECTION><code>DELEGATION_CERT_SELECTION</code></a><br>→ allows to choose authentication certificate requested by and app on behalf of the user through a broadcast receiver and also grant usage of an authentication certiciate to app.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_ENABLE_SYSTEM_APP><code>DELEGATION_ENABLE_SYSTEM_APP</code></a><br>→ allows app to enable system apps.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_INSTALL_EXISTING_PACKAGE><code>DELEGATION_INSTALL_EXISTING_PACKAGE</code></a><br>→ allows app to install an app in Work Profile if already present in personal profile or in main profile when using Work Managed Device and package was kept after app removal.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_KEEP_UNINSTALLED_PACKAGES><code>DELEGATION_KEEP_UNINSTALLED_PACKAGES</code></a><br>→ allows app to define if a package must be kept on device after app removal.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_NETWORK_LOGGING><code>DELEGATION_NETWORK_LOGGING</code></a><br>→ allows an app to enable network logging and read them through a broadcast receiver.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_PACKAGE_ACCESS><code>DELEGATION_PACKAGE_ACCESS</code></a><br>→ allows app to get apps status (hidden and suspended) and set it.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_PERMISSION_GRANT><code>DELEGATION_PERMISSION_GRANT</code></a><br>→ allows app to define apps permissions.</li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_SECURITY_LOGGING><code>DELEGATION_SECURITY_LOGGING</code></a><br>→ allows an app to enable security logging (app permission changes, authentication attempts, system integrity issues, security policy vilations, ect.) and read them through a broadcast receiver.</li></ul><h2 id=examples>Examples</h2><h3 id=wi-fi-onoff-button>Wi-Fi On/Off button</h3><p>A customer requested a solution that would allow users to enable or disable Wi-Fi while in kiosk mode, without giving them access to the full network settings. On Android, this is not possible through an app starting from Android 11. Therefore, we had to find an alternative approach. Using the newer method (i.e., showing the network chooser pop-up) requires the Settings app to be accessible in kiosk mode, which could also allow users to access all network-related settings.</p><p>As a solution, we used the <code>DELEGATION_APP_RESTRICTIONS</code> scope and created an app that sets the Wi-Fi state via the OEMConfig app restrictions. In this case, the customer was using Honeywell devices, so we applied <a href="https://play.google.com/store/apps/details?id=com.honeywell.oemconfig&amp;hl=fr">Honneywell UEMConnect</a> restrictions, as described below:</p><pre tabindex=0><code>com.honeywell.oemconfig
.
└── network_configuration (bundle)
    └── wifi_settings (bundle)
        └── WifiEnable (string)
</code></pre><p>network_configuration.wifi_settings.WifiEnable</p><table><thead><tr><th>State</th><th>Restriction value</th></tr></thead><tbody><tr><td>On</td><td><code>3</code></td></tr><tr><td>Off</td><td><code>1</code></td></tr></tbody></table><p>On the app, when user clicks on the switch input, it reads the app restrictions sent by the MDM solution to UEMConnect, modify it with the values described above and apply it to the UEMConnect again (thanks to the delagation scope). After successfully making it work, we also added brightness, ring volume and rotation control.</p><div><img alt="Take bug report" src=/posts/android-dpc-delegation/wifi-onoff-app.png style=width:24%;display:block;margin:auto></div><p>Here is sample code to set app restrictions as explained:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Check if app has delagation for app restrictions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>hasDelegation</span>(context: Context): Boolean {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> dpm = context.getSystemService(<span style=color:#a6e22e>Context</span>.DEVICE_POLICY_SERVICE) <span style=color:#66d9ef>as</span> DevicePolicyManager
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> packageName = context.applicationContext.packageName
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> delegatedScopes = dpm.getDelegatedScopes(<span style=color:#66d9ef>null</span>, packageName)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> hasDelegation =  delegatedScopes.contains(<span style=color:#a6e22e>DevicePolicyManager</span>.DELEGATION_APP_RESTRICTIONS)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(!hasDelegation){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Toast</span>.makeText(context, <span style=color:#e6db74>&#34;Delegated scope DELEGATION_APP_RESTRICTIONS missing.&#34;</span>, <span style=color:#a6e22e>Toast</span>.LENGTH_LONG).show()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hasDelegation
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set restrictions to the specified package
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>setRestrictions</span>(context: Context, packageName: String, kvps:  Array&lt;Pair&lt;String, Any&gt;&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> dpm = context.getSystemService(<span style=color:#a6e22e>Context</span>.DEVICE_POLICY_SERVICE) <span style=color:#66d9ef>as</span> DevicePolicyManager
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> restrictions: Bundle = dpm.getApplicationRestrictions(<span style=color:#66d9ef>null</span>, packageName).apply {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (kvp <span style=color:#66d9ef>in</span> kvps){
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Log</span>.d(<span style=color:#e6db74>&#34;AppRestrictions&#34;</span>, <span style=color:#e6db74>&#34;Setting restriction: </span><span style=color:#e6db74>${kvp.first}</span><span style=color:#e6db74> = </span><span style=color:#e6db74>${kvp.second}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            setNestedRestrictionValue(<span style=color:#66d9ef>this</span>, kvp.first, kvp.second)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    dpm.setApplicationRestrictions(<span style=color:#66d9ef>null</span>, packageName, restrictions)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update restriction Bundle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>setNestedRestrictionValue</span>(root: Bundle, keyPath: String, <span style=color:#66d9ef>value</span>: Any) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> keys = keyPath.split(<span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> current = root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span> until keys.size - <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> key = keys[i]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> next = current.getBundle(key)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (next <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>val</span> newBundle = Bundle()
</span></span><span style=display:flex><span>            current.putBundle(key, newBundle)
</span></span><span style=display:flex><span>            current = newBundle
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            current = next
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> finalKey = keys.last()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> (<span style=color:#66d9ef>value</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>is</span> Boolean <span style=color:#f92672>-&gt;</span> current.putBoolean(finalKey, <span style=color:#66d9ef>value</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>is</span> Int <span style=color:#f92672>-&gt;</span> current.putInt(finalKey, <span style=color:#66d9ef>value</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>is</span> String <span style=color:#f92672>-&gt;</span> current.putString(finalKey, <span style=color:#66d9ef>value</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>is</span> Float <span style=color:#f92672>-&gt;</span> current.putFloat(finalKey, <span style=color:#66d9ef>value</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>is</span> Long <span style=color:#f92672>-&gt;</span> current.putLong(finalKey, <span style=color:#66d9ef>value</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>throw</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Unsupported type: </span><span style=color:#e6db74>${value::class}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//////////////////////////////////////////////////////////////////////////////////////////////////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Code can be used like this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span>(hasDelegation(context)){
</span></span><span style=display:flex><span>  setRestrictions(
</span></span><span style=display:flex><span>      context, <span style=color:#e6db74>&#34;com.honeywell.oemconfig&#34;</span>, arrayOf(
</span></span><span style=display:flex><span>          Pair(<span style=color:#e6db74>&#34;network_configuration.wifi_settings.WifiEnable&#34;</span>, <span style=color:#e6db74>&#34;3&#34;</span>),
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=authentication-certificate-preselection>Authentication certificate preselection</h3><p>For my first time using delegated permissions, I was looking for a solution for a customer who asked whether it was possible to preselect a certificate to automate authentication against their IdP. Unfortunately, this isn&rsquo;t possible, even with Chrome-managed restrictions.</p><p>We would be satisfied if, at the very least, we could prevent users from selecting the wrong certificate by preselecting the correct certificate alias while still prompting them to allow its usage by the app.</p><p>After some research, I found that this can be achieved using <code>DELEGATION_CERT_SELECTION</code> in combination with a <code>DelegatedAdminReceiver</code>.</p><p>You can find my fully functionnal app that leverage app config to setup mapping on Google Play : <a href="https://play.google.com/store/apps/details?id=com.nosari20.managedcertificateselection">Managed Private Key Mapping</a></p><div><img alt="Take bug report" src=/posts/android-dpc-delegation/cert-selection-app.png style=width:24%;display:block;margin:auto></div><p>Here his sample code to do it:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyDelegatedAdminReceiver</span>: DelegatedAdminReceiver() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onChoosePrivateKeyAlias</span>(
</span></span><span style=display:flex><span>        context: Context,
</span></span><span style=display:flex><span>        intent: Intent,
</span></span><span style=display:flex><span>        uid: Int,
</span></span><span style=display:flex><span>        rawUri: Uri?,
</span></span><span style=display:flex><span>        alias: String?
</span></span><span style=display:flex><span>    ): String? {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> packageManager: PackageManager = context.packageManager
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>val</span> source = packageManager.getNameForUid(uid) <span style=color:#75715e>// get package name of the app that request the certificate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>val</span> uri = <span style=color:#a6e22e>Uri</span>.decode(rawUri.toString()).replace(<span style=color:#e6db74>&#34;/&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)  <span style=color:#75715e>// get the uri for which the certificate will be used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(source <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;com.android.chrome&#34;</span> <span style=color:#f92672>&amp;&amp;</span> uri <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;example.com&#34;</span>){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;MY_CERT_ALIAS&#34;</span> <span style=color:#75715e>// return cert alias without prompting and also allow app to use it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span> <span style=color:#75715e>// user will be prompted to choose
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// return KeyChain.KEY_ALIAS_SELECTION_DENIED if you want to deny access to keychain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=sources--usefull-resources>Sources / usefull resources</h2><ul><li><a href=https://developer.android.com/reference/android/app/admin/DelegatedAdminReceiver>https://developer.android.com/reference/android/app/admin/DelegatedAdminReceiver</a></li><li><a href=https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_APP_RESTRICTIONS>https://developer.android.com/reference/android/app/admin/DevicePolicyManager#DELEGATION_APP_RESTRICTIONS</a></li></ul></p></article><div id=comments><script>var commentsDiv,id="9";if(id){let t="https://github.com/nosari20/nosari20.github.io/issues/".concat(id),n="https://api.github.com/repos/nosari20/nosari20.github.io/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"' target='_blank'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"' target='_blank'>",e.user.login,e.user.login=="nosari20"?" (OP)":"","</a></b>","<em> on ",new Date(e.created_at).toLocaleString("en"),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section><script src="/js/app.js?v=1.0"></script></body></html>