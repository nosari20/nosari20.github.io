<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Synchronize macOS account picture with Entra ID (formerly Azure AD) | Nosari20</title>
<meta name=description content="Improve user experience by synchronizing macOS account picture with Entra ID."><meta name=author content="Florent NOSARI"><meta name=google-site-verification content="l3oU_IprnsBv0fmr4tY7n9XdxnmZ0oum0x1GeGe5hkI"><meta property="og:url" content="https://nosari20.github.io//posts/macos-m365-picture/"><meta property="og:title" content="Synchronize macOS account picture with Entra ID (formerly Azure AD) | Nosari20"><meta property="og:author" content="Florent NOSARI"><meta property="og:description" content="Improve user experience by synchronizing macOS account picture with Entra ID."><meta property="og:image" content="https://nosari20.github.io//posts/macos-m365-picture/_og.png?"><meta property="og:article:published_time" content="2024-01-26 00:00:00 +0000 UTC"><meta property="og:article:modified_time" content="2024-01-26 00:00:00 +0000 UTC"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content="nosari20.github.io"><meta property="twitter:url" content="https://nosari20.github.io//posts/macos-m365-picture/"><meta name=twitter:title content="Synchronize macOS account picture with Entra ID (formerly Azure AD) | Nosari20"><meta name=twitter:description content="Improve user experience by synchronizing macOS account picture with Entra ID."><meta name=twitter:image content="https://nosari20.github.io//posts/macos-m365-picture/_og.png?"><meta name=theme-color content="#302F2A"><link rel=icon href=/images/favicon.png><link rel=stylesheet href="/css/styles.css?v=2.1"><link rel=stylesheet href="/css/print.css?v=1.0" media=print></head><body><nav><div id=nav-toggle><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M3 17h18a1 1 0 01.117 1.993L21 19H3a1 1 0 01-.117-1.993L3 17h18H3zm0-6 18-.002a1 1 0 01.117 1.993l-.117.007L3 13a1 1 0 01-.117-1.993L3 11l18-.002L3 11zm0-6h18a1 1 0 01.117 1.993L21 7H3a1 1 0 01-.117-1.993L3 5h18H3z" fill="#fff"/></svg></div><a href=/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M6.248 16.002c.966.0 1.75.784 1.75 1.75v2.498A1.75 1.75.0 016.248 22H3.75A1.75 1.75.0 012 20.25v-2.498c0-.966.784-1.75 1.75-1.75h2.498zM9.748 18h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 18h11.505H9.748zm-3.5-8.999c.966.0 1.75.784 1.75 1.75v2.498a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 13.249V10.75C2 9.784 2.784 9 3.75 9h2.498zM9.748 11h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 11h11.505H9.748zm-3.5-9c.966.0 1.75.784 1.75 1.75v2.498a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 6.248V3.75C2 2.784 2.784 2 3.75 2h2.498zm3.5 2h11.505a.75.75.0 01.102 1.493l-.102.007H9.748a.75.75.0 01-.102-1.493L9.748 4h11.505H9.748z" fill="#fff"/></svg>
Home
</a><a href=/tags/device-management/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M8.254 8.003c.967.0 1.75.784 1.75 1.75v9.5a1.75 1.75.0 01-1.75 1.75H3.75A1.75 1.75.0 012 19.253v-9.5c0-.966.784-1.75 1.75-1.75h4.504zm-2.002 9.495h-.5a.75.75.0 100 1.5h.5a.75.75.0 000-1.5zM21.25 16.5a.75.75.0 01.102 1.493L21.25 18H11v-1.5h10.25zM18.25 5c.966.0 1.75.784 1.75 1.75v7.5A1.75 1.75.0 0118.25 16H11V9A2 2 0 009.15 7.006L9 7H4v-.25C4 5.784 4.784 5 5.75 5h12.5z" fill="#fff"/></svg>
Device Management
</a><a href=/tags/dev-scripting/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="m8.086 18.611 5.996-14.004a1 1 0 011.878.677l-.04.11-5.996 14.004a1 1 0 01-1.878-.677l.04-.11 5.996-14.004L8.086 18.61zm-5.793-7.318 4-4a1 1 0 011.497 1.32l-.083.094L4.414 12l3.293 3.293a1 1 0 01-1.32 1.498l-.094-.084-4-4a1 1 0 01-.083-1.32l.083-.094 4-4-4 4zm14-4.001a1 1 0 011.32-.083l.093.083 4.001 4.001a1 1 0 01.083 1.32l-.083.095-4.001 3.995a1 1 0 01-1.497-1.32l.084-.095L19.584 12l-3.293-3.294a1 1 0 010-1.414z" fill="#fff"/></svg>
Dev. / Scripting
</a><a href=/tags/misc/><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M9 4.5v6.238c0 .375-.094.744-.273 1.074L7.54 14h8.922l-1.188-2.188A2.25 2.25.0 0115 10.738V4.5h1A.75.75.0 0016 3H8a.75.75.0 000 1.5h1zm8.275 11H6.725l-1.582 2.915A1.75 1.75.0 006.68 21h10.638a1.75 1.75.0 001.538-2.585L17.275 15.5z" fill="#fff"/></svg>
Misc.</a><footer><p class="footer text-center">Copyright (Â©) 2024 Florent NOSARI</p></footer></nav><section><header><span>Nosari20</span>
<span style=text-align:right><a href=https://github.com/nosari20/ target=_blank><svg height="26" aria-hidden="true" viewBox="0 0 24 24" width="32" data-view-component="true"><path d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546.0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678.0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048.0.0.963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977.0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09.0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128.0 1.538-.014 2.774-.014 3.162.0.302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75z" fill="#fff"/></svg></a></span></header><article><image class=image-header alt="Synchronize macOS account picture with Entra ID (formerly Azure AD)" src=/posts/macos-m365-picture/_header.png?><h1><a class=title href=/posts/macos-m365-picture/>Synchronize macOS account picture with Entra ID (formerly Azure AD)</a></h3><div class=metadata>Published on: <time datetime=2024-01-26>Jan 26, 2024</time>
- Last update: <time datetime=2024-01-26>Jan 26, 2024</time><div class=meta-url>Url: https://nosari20.github.io/posts/macos-m365-picture/</div><ul class=tags><li><a href=https://nosari20.github.io/tags/device-management>device-management</a></li><li><a href=https://nosari20.github.io/tags/macos>macos</a></li><li><a href=https://nosari20.github.io/tags/powershell>powershell</a></li><li><a href=https://nosari20.github.io/tags/shell>shell</a></li><li><a href=https://nosari20.github.io/tags/azure>azure</a></li><li><a href=https://nosari20.github.io/tags/entra-id>entra-id</a></li><li><a href=https://nosari20.github.io/tags/dev-scripting>dev-scripting</a></li></ul></div><p><h2 id=content>Content</h2><ul><li>Purpose</li><li>Solution</li><li>Sources / usefull resources</li></ul><h2 id=purpose>Purpose</h2><p>One day, I wanted to synchronize Entra ID (formerly Azure AD) account picture with macOS devices account picture, so user will have the same behavior on Windows and macOS. I waited for Entra ID Platform SSO to comes out, but public preview shows that it does not synchronize user picture.</p><div><img alt="User accounts list" src=/posts/macos-m365-picture/user-accounts.png style=width:50%;display:block;margin:auto></div><h2 id=solution>Solution</h2><p>Here is a quick overview of what my solution looks like:</p><ul><li>Azure Function as midleware which will use MS Graph API to retrieve user picture. I choose to use it to prevent Graph API credentials exposure (see my previous <a href=https://nosari20.github.io/posts/device-to-intune-channel/>post</a> about this).</li><li>A Shell script, run periodically by MDM, which perform HTTP calls to the Azure Function in order to retrieve user picture and set it as account picture.</li></ul><h2 id=azure-function-code>Azure Function code</h2><p>This Azure function uses the same base as the one <a href=https://nosari20.github.io/posts/device-to-intune-channel/>here</a> and require client certificate (certificate is validated in function code). You have to change line 42 to put the base64 string of your own CA (and sub-CA). Unfortunately you cannot use Intune MDM certificate as it does not allow all apps to use it (do not forget to allow all apps to use the certificate you deploy, I suggest to use a dedicated configuration and put purpose as OU like in my example).</p><p>The certificate is checked but you can improve security by adding the following checks:</p><ul><li>Check that device still exist in MDM</li><li>Check that device is compliant</li><li>Put owner UPN in certificate</li></ul><p>To simplify requests, I choose to make a unique endpoint and return picture data directly when applicable.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Using namespace System.Net
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Input bindings are passed in via param block.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Param</span>($Request, $TriggerMetadata)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>$ApplicationID = <span style=color:#e6db74>&#34;&lt;APPID&gt;&#34;</span>
</span></span><span style=display:flex><span>$TenantID = <span style=color:#e6db74>&#34;&lt;TENANTID&gt;&#34;</span>
</span></span><span style=display:flex><span>$AccessSecret = <span style=color:#e6db74>&#34;&lt;SECRET&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to check certificate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Test-Certificate() {
</span></span><span style=display:flex><span>    $ClientCertificateBase64 = $Request.Headers.<span style=color:#e6db74>&#34;X-ARR-ClientCert&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Check if certificate is provided</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>If</span> (<span style=color:#f92672>-not</span> $ClientCertificateBase64) {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::BadRequest
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Certificate not provided in request.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Else</span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># If provided, check trust</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Convert certificate to object</span>
</span></span><span style=display:flex><span>        $ClientCertificate = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Certificate2</span>]([<span style=color:#66d9ef>System.Convert</span>]::FromBase64String($ClientCertificateBase64))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Create custom chain object to trust only one authority</span>
</span></span><span style=display:flex><span>        $Chain = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Chain</span>]::Create()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Do no check if certficate is revoked</span>
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.RevocationMode = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509RevocationMode</span>]::NoCheck
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Use custom trust store</span>
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.TrustMode = [<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509ChainTrustMode</span>]::CustomRootTrust
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## Add CAs to custom trust store</span>
</span></span><span style=display:flex><span>        $ca=<span style=color:#e6db74>&#34;&lt;BASE64CACERT&gt;&#34;</span> <span style=color:#75715e># Without &#39;begin cert&#39; and &#39;end cert&#39;</span>
</span></span><span style=display:flex><span>        $Chain.ChainPolicy.CustomTrustStore.Add([<span style=color:#66d9ef>System.Security.Cryptography.X509Certificates.X509Certificate2</span>]([<span style=color:#66d9ef>System.Convert</span>]::FromBase64String($ca)))  | Out-Null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>## build chain : return true if valid trust chain</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> (<span style=color:#f92672>-not</span> $Chain.build($ClientCertificate)) {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>            Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>                StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::BadRequest
</span></span><span style=display:flex><span>                Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Certificate not valid (</span>$($Chain.ChainStatus.StatusInformation)<span style=color:#e6db74>).&#39;}&#34;</span>
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>Else</span> {
</span></span><span style=display:flex><span>            $ClientCertificate
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to authenticate and retrieve Graph API OAuth token</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Get-GraphAPIToken() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $Body = @{    
</span></span><span style=display:flex><span>        Grant_Type    = <span style=color:#e6db74>&#34;client_credentials&#34;</span>
</span></span><span style=display:flex><span>        Scope         = <span style=color:#e6db74>&#34;https://graph.microsoft.com/.default&#34;</span>
</span></span><span style=display:flex><span>        client_Id     = $ApplicationID
</span></span><span style=display:flex><span>        Client_Secret = $AccessSecret
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>        $ConnectGraph = Invoke-RestMethod -Uri <span style=color:#e6db74>&#34;https://login.microsoftonline.com/</span>$TenantID<span style=color:#e6db74>/oauth2/v2.0/token&#34;</span> `
</span></span><span style=display:flex><span>        -Method POST -Body $Body
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Body:</span><span style=color:#ae81ff>`n</span>$Body<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>If</span>(<span style=color:#f92672>-not</span> $ConnectGraph.access_token){
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Internal server error while getting token.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $ConnectGraph.access_token
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to get user id using Graph API</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Get-UserID($UPN) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $Bearer = Get-GraphAPIToken
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get data</span>
</span></span><span style=display:flex><span>    $url = <span style=color:#e6db74>&#34;https://graph.microsoft.com/beta/users(&#39;</span>$UPN<span style=color:#e6db74>&#39;)?</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>select=displayName&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $UserData = (Invoke-RestMethod -Method <span style=color:#e6db74>&#39;GET&#39;</span> -Headers @{Authorization = <span style=color:#e6db74>&#34;Bearer </span>$($Bearer)<span style=color:#e6db74>&#34;</span>} -Uri $Url)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Internal server error while getting picture metadata.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $UserData.id
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to get profile picture metadata using Graph API</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Get-PictureMetadata($id) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $Bearer = Get-GraphAPIToken
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get Metadata</span>
</span></span><span style=display:flex><span>    $Url = <span style=color:#e6db74>&#34;https://graph.microsoft.com/v1.0/users/</span>$id<span style=color:#e6db74>/photo/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $PictureMetadataRequest = (Invoke-RestMethod -Method <span style=color:#e6db74>&#39;GET&#39;</span> -Headers @{Authorization = <span style=color:#e6db74>&#34;Bearer </span>$($Bearer)<span style=color:#e6db74>&#34;</span>} -Uri $Url)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Internal server error while getting picture metadata.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $PictureMetadataRequest
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Function to get profile picture data using Graph API</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> Get-Picture($id) {
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    $Bearer = Get-GraphAPIToken
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get file</span>
</span></span><span style=display:flex><span>    $Url = <span style=color:#e6db74>&#34;https://graph.microsoft.com/v1.0/users/</span>$id<span style=color:#e6db74>/photo/</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>value&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Try</span> {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $PictureFileRequest = (Invoke-WebRequest  -Method <span style=color:#e6db74>&#39;GET&#39;</span> -Headers @{Authorization = <span style=color:#e6db74>&#34;Bearer </span>$($Bearer)<span style=color:#e6db74>&#34;</span>} -Uri $Url)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>Catch</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Error for </span>$Url<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusCode: </span>$($_.Exception.Response.StatusCode.value__ )<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;StatusDescription: </span>$($_.Exception.Response.StatusDescription)<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;Internal server error while getting picture.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $PictureFileRequest.Content  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Test client certificate</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Test-Certificate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Handle incomming requests</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>If</span>($Request.Method  <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;GET&#34;</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Retrieve UPN</span>
</span></span><span style=display:flex><span>    $UserUPN = $Request.Query.UPN
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>If</span>(<span style=color:#f92672>-not</span> $UserUPN){
</span></span><span style=display:flex><span>        Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>            StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::InternalServerError
</span></span><span style=display:flex><span>            Body = <span style=color:#e6db74>&#34;{&#39;status&#39;:&#39;error&#39;,&#39;error&#39;:&#39;UPN not provided.&#39;}&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        exit
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>################ Retrieve picture using Graph API  ###########################</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add Azure AD satus to note</span>
</span></span><span style=display:flex><span>    $Id = Get-UserID($UserUPN)
</span></span><span style=display:flex><span>    $Metadata = Get-PictureMetadata($Id)
</span></span><span style=display:flex><span>    $File = Get-Picture($Id)
</span></span><span style=display:flex><span>    <span style=color:#75715e>#######################################################################################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Associate values to output bindings by calling &#39;Push-OutputBinding&#39;.</span>
</span></span><span style=display:flex><span>    Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>        StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::OK
</span></span><span style=display:flex><span>        Body = [<span style=color:#66d9ef>byte[]</span>] $File
</span></span><span style=display:flex><span>        ContentType = $Metadata.<span style=color:#e6db74>&#34;@odata.mediaContentType&#34;</span>
</span></span><span style=display:flex><span>        Headers = @{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Content-Disposition&#39;</span> = <span style=color:#e6db74>&#39;attachment; filename=&#34;profile.jpeg&#34;&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    exit
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Unknown method / request</span>
</span></span><span style=display:flex><span>Push-OutputBinding -Name Response -Value ([<span style=color:#66d9ef>HttpResponseContext</span>]@{
</span></span><span style=display:flex><span>    StatusCode = [<span style=color:#66d9ef>HttpStatusCode</span>]::MethodNotAllowed
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=shell-script>Shell script</h2><p>The client script relies on work from <a href=https://copyprogramming.com/howto/setting-account-picture-jpegphoto-with-dscl-in-terminal>copyprogramming.com</a> for setting user picture. I choose to iterate over users accounts to make all users have the proper picture, as I am using <a href=https://techcommunity.microsoft.com/t5/microsoft-entra-blog/coming-soon-platform-sso-for-macos/ba-p/3902280>Entra ID Platform SSO</a> to create accounts I filter the result to get only user containing domain (@ is ommited during creation but user have to login using UPN as well).</p><p>You may have to change line 107 to match what you choose as OU and eventually change the <code>findCertAlias</code> function if you need more criteria.</p><p>Note: the string <code>CURL_SSL_BACKEND=secure_transport</code> before the <code>curl</code> command is used in order to allow <code>curl</code> to use certificates in keychain instead of files.</p><p>Note 2: Users will need to reboot devices to apply change on login screen.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>APIURL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;AZURE-FUNCTION_URL&gt;&#34;</span>
</span></span><span style=display:flex><span>DOMAIN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;DOMAIN&gt;&#34;</span>
</span></span><span style=display:flex><span>CANAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&lt;CANAME&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Search certificate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> findCertAlias <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CERTISSUER<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>    CERTOU<span style=color:#f92672>=</span>$2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    /usr/bin/security find-certificate -a -p &gt; /tmp/certs.pem
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> read line; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$line<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;--BEGIN&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            cert<span style=color:#f92672>=</span>$line
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            cert<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$cert<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$&#39;\n&#39;</span><span style=color:#e6db74>&#34;</span>$line<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$line<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;--END&#34;</span>* <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;</span>$cert<span style=color:#e6db74>&#34;</span> &gt; /tmp/checkcert.pem
</span></span><span style=display:flex><span>                subject<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl x509 -subject -noout -in /tmp/checkcert.pem | sed <span style=color:#e6db74>&#39;s/.*CN=\([^/]*\).*/\1/&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>                subjectOU<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl x509 -subject -noout -in /tmp/checkcert.pem | sed <span style=color:#e6db74>&#39;s/.*OU=\([^/]*\).*/\1/&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>                issuer<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl x509 -issuer -noout -in /tmp/checkcert.pem | sed <span style=color:#e6db74>&#39;s/.*CN=\([^/]*\).*/\1/&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>                purpose<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>openssl x509 -purpose -noout -in /tmp/checkcert.pem<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$issuer<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> $CERTISSUER <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$subjectOU<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> $CERTOU <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>echo $purpose | grep -q <span style=color:#e6db74>&#34;SSL client CA : No&#34;</span> <span style=color:#f92672>)</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                    echo $subject
</span></span><span style=display:flex><span>                    break
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span> &lt; /tmp/certs.pem
</span></span><span style=display:flex><span>    rm -f /tmp/certs.pem
</span></span><span style=display:flex><span>    rm -f /tmp/checkcert.pem
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set user picture for a specific user</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> setUserPicture <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Inspiraton: https://copyprogramming.com/howto/setting-account-picture-jpegphoto-with-dscl-in-terminal</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    USERNAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    USERPIC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    PICTUREFOLDER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/Library/User Pictures/Pictures&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Check if user exist</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> /usr/bin/id -u <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> &amp;&gt;/dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Copy picture to public folder and set permissions to allow login windows display</span>
</span></span><span style=display:flex><span>        mkdir -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICTUREFOLDER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        cp <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>USERPIC<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICTUREFOLDER<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpeg&#34;</span>
</span></span><span style=display:flex><span>        chmod a+rx <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICTUREFOLDER<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpeg&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># Delete previous data</span>
</span></span><span style=display:flex><span>        dscl . delete /Users/$USERNAME JPEGPhoto <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        dscl . delete /Users/$USERNAME Picture <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Set new profile picture</span>
</span></span><span style=display:flex><span>        dscl . create /Users/$USERNAME Picture <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICTUREFOLDER<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpeg&#34;</span>
</span></span><span style=display:flex><span>        PICIMPORT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp /tmp/<span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span>_dsimport.XXXXXX<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        MAPPINGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0x0A 0x5C 0x3A 0x2C&#39;</span>
</span></span><span style=display:flex><span>        ATTRS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;dsRecTypeStandard:Users 2 dsAttrTypeStandard:RecordName externalbinary:dsAttrTypeStandard:JPEGPhoto&#39;</span>
</span></span><span style=display:flex><span>        printf <span style=color:#e6db74>&#34;%s %s \n%s:%s&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>MAPPINGS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>ATTRS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICTUREFOLDER<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpeg&#34;</span> &gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICIMPORT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        /usr/bin/dsimport <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICIMPORT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> /Local/Default M <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        rm <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>PICIMPORT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Download user picture</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> downloadUserPicture <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CERTALIAS<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span>    UPN<span style=color:#f92672>=</span>$2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>CURL_SSL_BACKEND<span style=color:#f92672>=</span>secure_transport curl -X GET <span style=color:#e6db74>&#34;</span>$APIURL<span style=color:#e6db74>&amp;UPN=</span>$UPN<span style=color:#e6db74>&#34;</span> --cert <span style=color:#e6db74>&#34;</span>$CERTALIAS<span style=color:#e6db74>&#34;</span> -sS --write-out <span style=color:#e6db74>&#39;|%{http_code}\n&#39;</span> -o /tmp/$UPN.jpeg<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    RC<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>RC<span style=color:#e6db74>}</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        IFS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;|&#39;</span>
</span></span><span style=display:flex><span>        read -a response <span style=color:#f92672>&lt;&lt;&lt;</span> <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>response[1]<span style=color:#e6db74>}</span> !<span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;Error for </span><span style=color:#e6db74>${</span>APIURL<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;UPN=</span><span style=color:#e6db74>${</span>UPN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;HTTP Code: </span><span style=color:#e6db74>${</span>response[1]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>            echo <span style=color:#e6db74>&#34;Body: </span><span style=color:#66d9ef>$(</span>cat /tmp/<span style=color:#e6db74>${</span>UPN<span style=color:#e6db74>}</span>.jpeg<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>            rm -f /tmp/$UPN.jpeg
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;/tmp/</span>$UPN<span style=color:#e6db74>.jpeg&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Error for </span><span style=color:#e6db74>${</span>APIURL<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;UPN=</span><span style=color:#e6db74>${</span>UPN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Exit Code: </span><span style=color:#e6db74>${</span>RC<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Output: </span>$response<span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        rm -f /tmp/$UPN.jpeg
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get alias of Intune provided certificate</span>
</span></span><span style=display:flex><span>certAlias<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>findCertAlias <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;AzureFunction&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> user in <span style=color:#66d9ef>$(</span>dscl . -list /Users | grep <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo $user
</span></span><span style=display:flex><span>    <span style=color:#75715e># @ must be added</span>
</span></span><span style=display:flex><span>    picture<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>downloadUserPicture $certAlias <span style=color:#e6db74>${</span>user//<span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>&#34;</span>/<span style=color:#e6db74>&#34;@</span>$DOMAIN<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>}</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    RC<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>RC<span style=color:#e6db74>}</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        setUserPicture $user $picture
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=sources--usefull-resources>Sources / usefull resources</h2><ul><li><a href=https://copyprogramming.com/howto/setting-account-picture-jpegphoto-with-dscl-in-terminal>https://copyprogramming.com/howto/setting-account-picture-jpegphoto-with-dscl-in-terminal</a></li><li><a href=https://nosari20.github.io/posts/device-to-intune-channel/>https://nosari20.github.io/posts/device-to-intune-channel/</a></li></ul></p></article><div id=comments><script>var commentsDiv,id="8";if(id){let t="https://github.com/nosari20/nosari20.github.io/issues/".concat(id),n="https://api.github.com/repos/nosari20/nosari20.github.io/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"' target='_blank'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"' target='_blank'>",e.user.login,e.user.login=="nosari20"?" (OP)":"","</a></b>","<em> on ",new Date(e.created_at).toLocaleString("en"),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section><script src="/js/app.js?v=1.0"></script></body></html>